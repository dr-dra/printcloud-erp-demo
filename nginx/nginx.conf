# ============================================================================
# NGINX CONFIGURATION FOR PRINTCLOUD (PRODUCTION)
# ============================================================================
# Nginx is a reverse proxy that sits in front of your application.
#
# What is a reverse proxy?
# - Receives requests from users
# - Forwards them to the appropriate backend service
# - Returns responses back to users
#
# Why use Nginx?
# - Better performance for static files
# - SSL/TLS termination (HTTPS)
# - Load balancing capabilities
# - Better security (hides backend details)
# - Compression and caching
# ============================================================================

# Upstream servers (backend services)
# "upstream" defines a group of servers that Nginx can proxy to
upstream backend {
    # "backend:8000" refers to the Docker service name and port
    # Docker's internal DNS resolves "backend" to the container's IP
    server backend:8000;
}

upstream frontend {
    # Next.js production server
    server frontend:3000;
}

# Main server block
server {
    # Listen on port 80 (HTTP)
    # In production, you'd add SSL/HTTPS on port 443
    listen 80;

    # Server name (replace with your domain in production)
    server_name localhost;

    # Maximum upload size (for customer documents, quotations, etc.)
    # Adjust based on your needs
    client_max_body_size 50M;

    # Logging
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # ========================================================================
    # API REQUESTS - Route to Django Backend
    # ========================================================================
    # Any request starting with /api/ goes to the Django backend
    location /api/ {
        proxy_pass http://backend;

        # Pass original request information to backend
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Timeouts (important for long-running requests like PDF generation)
        proxy_connect_timeout 120s;
        proxy_send_timeout 120s;
        proxy_read_timeout 120s;
    }

    # ========================================================================
    # DJANGO ADMIN - Route to Django Backend
    # ========================================================================
    location /admin/ {
        proxy_pass http://backend;

        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ========================================================================
    # DJANGO STATIC FILES - Serve directly from Nginx (faster)
    # ========================================================================
    location /static/ {
        # Serve static files from the backend container's staticfiles directory
        alias /app/staticfiles/;

        # Enable caching for better performance
        expires 30d;
        add_header Cache-Control "public, immutable";
    }

    # ========================================================================
    # DJANGO MEDIA FILES - Serve directly from Nginx (faster)
    # ========================================================================
    location /media/ {
        # Serve media files (uploads, profile pictures, etc.)
        alias /app/media/;

        # Enable caching
        expires 7d;
        add_header Cache-Control "public";
    }

    # ========================================================================
    # FRONTEND - Route everything else to Next.js
    # ========================================================================
    location / {
        proxy_pass http://frontend;

        # Important for Next.js Server-Side Rendering (SSR)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;

        # Pass original request information
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ========================================================================
    # HEALTH CHECK ENDPOINT
    # ========================================================================
    # Simple endpoint to check if Nginx is running
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}

# ============================================================================
# OPTIONAL: SSL/HTTPS CONFIGURATION
# ============================================================================
# Uncomment and configure this when you're ready for HTTPS in production
# You'll need SSL certificates (use Let's Encrypt for free certificates)
#
# server {
#     listen 443 ssl http2;
#     server_name yourdomain.com;
#
#     ssl_certificate /etc/nginx/ssl/cert.pem;
#     ssl_certificate_key /etc/nginx/ssl/key.pem;
#
#     # Rest of the configuration (copy from the server block above)
# }
#
# # Redirect HTTP to HTTPS
# server {
#     listen 80;
#     server_name yourdomain.com;
#     return 301 https://$server_name$request_uri;
# }
# ============================================================================
